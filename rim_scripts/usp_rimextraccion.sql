USE [BDSidtefim-Test]
GO

/*» dbo.usp_Rim_Procedimiento_NuevaTablaDinamica ...*/
/*-----------------------------------------------------------------------------------------------------------------------*/
CREATE OR ALTER PROCEDURE dbo.usp_Rim_Procedimiento_NuevaTablaDinamica
(
	@nombreTabla VARCHAR(55)
)
AS
BEGIN
	DECLARE @sql NVARCHAR(MAX),
			@select NVARCHAR(100)

	SET @sql = N'CREATE TABLE ' + @nombreTabla
	SET @sql = @sql + N'(nId INT PRIMARY KEY IDENTITY(1, 1) NOT NULL, '
	SET @sql = @sql + N' nSubId INT DEFAULT 0, '
	SET @sql = @sql + N'dFecha_Creacion DATETIME DEFAULT GETDATE())'
	
	EXEC SP_EXECUTESQL @sql
	
	SET @select = N'SELECT * FROM ' + @nombreTabla
	EXEC SP_EXECUTESQL @select
END

-- » Test ...
-- DROP TABLE Tabla_Test_2030
EXEC dbo.usp_Rim_Procedimiento_NuevaTablaDinamica 'Tabla_Test_2030'

/*-----------------------------------------------------------------------------------------------------------------------*/

/*» dbo.usp_Rim_Procedimiento_ContarRegistrosTabla ...*/
/*-----------------------------------------------------------------------------------------------------------------------*/
CREATE OR ALTER PROCEDURE dbo.usp_Rim_Procedimiento_ContarRegistrosTabla
(
	@nombreTabla VARCHAR(55)
)
AS
BEGIN
	DECLARE @select NVARCHAR(100)
	SET @select = N'SELECT COUNT(1) FROM ' + @nombreTabla
	EXEC SP_EXECUTESQL @select
END


/*» Test ...*/
EXEC dbo.usp_Rim_Procedimiento_ContarRegExtraccion 'SidInterpol'

/*-----------------------------------------------------------------------------------------------------------------------*/

/*» dbo.usp_Rim_Procedimiento_ListarTablaDinamica ... */
/*-----------------------------------------------------------------------------------------------------------------------*/
CREATE PROCEDURE dbo.usp_Rim_Procedimiento_ListarTablaDinamica
(
	@nombreTabla VARCHAR(55)
)
AS
BEGIN
	DECLARE @sql NVARCHAR(MAX)

	SET @sql = N'SELECT * FROM ' + @nombreTabla
	EXEC SP_EXECUTESQL @sql
END

/*» Test ...*/
EXEC dbo.usp_Rim_Procedimiento_ListarTablaDinamica 'Rim_Extraccion_2021'
/*-----------------------------------------------------------------------------------------------------------------------*/

/*» dbo.usp_Rim_Procedimiento_ListarTablaDinamica ... */
/*-----------------------------------------------------------------------------------------------------------------------*/
CREATE OR ALTER PROCEDURE dbo.usp_Rim_Procedimiento_ListarTablaDinamicaPorSufijoDeCampo
(
	@nombreTabla VARCHAR(55),
	@sufijo VARCHAR(2)
)
AS
BEGIN
	DECLARE @sql NVARCHAR(MAX),
			@camposCsv VARCHAR(MAX) = (SELECT 
											STRING_AGG(CONCAT('[', isc.COLUMN_NAME), '], ') WITHIN GROUP (ORDER BY isc.ORDINAL_POSITION)
										FROM INFORMATION_SCHEMA.COLUMNS isc
										WHERE 
											isc.TABLE_NAME = @nombreTabla
											AND isc.COLUMN_NAME LIKE CONCAT('%', @sufijo))
	IF (@camposCsv IS NOT NULL)
		BEGIN
			SET @camposCsv = CONCAT(@camposCsv, ']')
			SET @sql = N'SELECT ' + @camposCsv + ' FROM ' + @nombreTabla
		END
	ELSE
		BEGIN
			SET @sql = N'SELECT TOP 0 * FROM INFORMATION_SCHEMA.TABLES'
		END

	EXEC SP_EXECUTESQL @sql
END

/*» Test ...*/
EXEC dbo.usp_Rim_Procedimiento_ListarTablaDinamicaPorSufijoDeCampo 'Control_Migratorio_2022', '_e'
SELECT * FROM Control_Migratorio_2022
/*-----------------------------------------------------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------------------------------------------------*/

/*» dbo.usp_Rim_Procedimiento_InsertarEnTablaDinamica ... */
/*-----------------------------------------------------------------------------------------------------------------------*/
CREATE OR ALTER PROCEDURE dbo.usp_Rim_Procedimiento_SaveTablaDinamica
(
	@nombreTabla VARCHAR(55),
	@sqlInsertValues NVARCHAR(MAX)
)
AS
BEGIN
	BEGIN TRY

		BEGIN TRAN tran_InsertarEnTablaDinamica
		EXEC SP_EXECUTESQL @sqlInsertValues
		COMMIT TRAN tran_InsertarEnTablaDinamica

		-- ► Registros insertados ...
		DECLARE @insertedRecords INT = (SELECT COUNT([value]) - 1 FROM STRING_SPLIT(REPLACE(@sqlInsertValues, 'INSERT', '|'), '|'))
		SELECT @insertedRecords

	END TRY
	BEGIN CATCH
		ROLLBACK TRAN tran_InsertarEnTablaDinamica
		PRINT ERROR_MESSAGE()
	END CATCH
END

/*» Test ...*/
EXEC dbo.usp_Rim_Procedimiento_SaveTablaDinamica @sqlInsertValues = ' VALUES(1, 1, 44661), (1, 1, 44662), (1, 1, 44663), (1, 1, 44664), (1, 1, 44665), (1, 1, 44666), (1, 1, 44667), (1, 1, 44668), (1, 1, 44669), (1, 1, 44670), (1, 1, 44671), (1, 1, 44672), (1, 1, 44673), (1, 1, 44674), (1, 1, 44675), (1, 1, 44676), (1, 1, 44677), (1, 1, 44678), (1, 1, 44679), (1, 1, 44680), (1, 1, 44681), (1, 1, 44682), (1, 1, 44683), (1, 1, 44684), (1, 1, 44685), (1, 1, 44686), (1, 1, 44687), (1, 1, 44688), (1, 1, 44689), (1, 1, 44690), (1, 1, 44691), (1, 1, 44692), (1, 1, 44693), (1, 1, 44694), (1, 1, 44695), (1, 1, 44696), (1, 1, 44697), (1, 1, 44698), (1, 1, 44699), (1, 1, 44700), (1, 1, 44701), (1, 1, 44702), (1, 1, 44703), (1, 1, 44704), (1, 1, 44705), (1, 1, 44706), (1, 1, 44707), (1, 1, 44708), (1, 1, 44709), (1, 1, 44710), (1, 1, 44711), (1, 1, 44712), (1, 1, 44713), (1, 1, 44714), (1, 1, 44715), (1, 1, 44716), (1, 1, 44717), (1, 1, 44718), (1, 1, 44719), (1, 1, 44720), (1, 1, 44721), (1, 1, 44722), (1, 1, 44723), (1, 1, 44724), (1, 1, 44725), (1, 1, 44726), (1, 1, 44727), (1, 1, 44728), (1, 1, 44729), (1, 1, 44730), (1, 1, 44731), (1, 1, 44732), (1, 1, 44733), (1, 1, 44734), (1, 1, 44735), (1, 1, 44736), (1, 1, 44737), (1, 1, 44738), (1, 1, 44739), (1, 1, 44740), (1, 1, 44741), (1, 1, 44742), (1, 1, 44743), (1, 1, 44744), (1, 1, 44745), (1, 1, 44746), (1, 1, 44747), (1, 1, 44748), (1, 1, 44749), (1, 1, 44750), (1, 1, 44751), (1, 1, 44752), (1, 1, 44753), (1, 1, 44754), (1, 1, 44755), (1, 1, 44756), (1, 1, 44757), (1, 1, 44758), (1, 1, 44759), (1, 1, 44760), (1, 1, 44761), (1, 1, 44762), (1, 1, 44763), (1, 1, 44764), (1, 1, 44765), (1, 1, 44766), (1, 1, 44767), (1, 1, 44768), (1, 1, 44769), (1, 1, 44770), (1, 1, 44771), (1, 1, 44772), (1, 1, 44773), (1, 1, 44774), (1, 1, 44775), (1, 1, 44776), (1, 1, 44777), (1, 1, 44778), (1, 1, 44779), (1, 1, 44780), (1, 1, 44781), (1, 1, 44782), (1, 1, 44783), (1, 1, 44784), (1, 1, 44785), (1, 1, 44786), (1, 1, 44787), (1, 1, 44788), (1, 1, 44789), (1, 1, 44790), (1, 1, 44791), (1, 1, 44792), (1, 1, 44793), (1, 1, 44794), (1, 1, 44795), (1, 1, 44796), (1, 1, 44797), (1, 1, 44798), (1, 1, 44799), (1, 1, 44800), (1, 1, 44801), (1, 1, 44802), (1, 1, 44803), (1, 1, 44804), (1, 1, 44805), (1, 1, 44806), (1, 1, 44807), (1, 1, 44808), (1, 1, 44809), (1, 1, 44810), (1, 1, 44811), (1, 1, 44812), (1, 1, 44813), (1, 1, 44814), (1, 1, 44815), (1, 1, 44816), (1, 1, 44817), (1, 1, 44818), (1, 1, 44819), (1, 1, 44820), (1, 1, 44821), (1, 1, 44822), (1, 1, 44823), (1, 1, 44824), (1, 1, 44825), (1, 1, 44826), (1, 1, 44827), (1, 1, 44828), (1, 1, 44829), (1, 1, 44830), (1, 1, 44831), (1, 1, 44832), (1, 1, 44833), (1, 1, 44834), (1, 1, 44835), (1, 1, 44836), (1, 1, 44837), (1, 1, 44838), (1, 1, 44839), (1, 1, 44840), (1, 1, 44841), (1, 1, 44842), (1, 1, 44843), (1, 1, 44844), (1, 1, 44845), (1, 1, 44846), (1, 1, 44847), (1, 1, 44848), (1, 1, 44849), (1, 1, 44850), (1, 1, 44851), (1, 1, 44852), (1, 1, 44853), (1, 1, 44854), (1, 1, 44855), (1, 1, 44856), (1, 1, 44857), (1, 1, 44858), (1, 1, 44859), (1, 1, 44860), (1, 1, 44861), (1, 1, 44862), (1, 1, 44863), (1, 1, 44864), (1, 1, 44865), (1, 1, 44866), (1, 1, 44867), (1, 1, 44868), (1, 1, 44869), (1, 1, 44870), (1, 1, 44871), (1, 1, 44872), (1, 1, 44873), (1, 1, 44874), (1, 1, 44875), (1, 1, 44876), (1, 1, 44877), (1, 1, 44878), (1, 1, 44879), (1, 1, 44880), (1, 1, 44881), (1, 1, 44882), (1, 1, 44883), (1, 1, 44884), (1, 1, 44885), (1, 1, 44886), (1, 1, 44887), (1, 1, 44888), (1, 1, 44889), (1, 1, 44890), (1, 1, 44891), (1, 1, 44892), (1, 1, 44893), (1, 1, 44894), (1, 1, 44895), (1, 1, 44896), (1, 1, 44897), (1, 1, 44898), (1, 1, 44899), (1, 1, 44900), (1, 1, 44901), (1, 1, 44902), (1, 1, 44903), (1, 1, 44904), (1, 1, 44905), (1, 1, 44906), (1, 1, 44907), (1, 1, 44908), (1, 1, 44909), (1, 1, 44910), (1, 1, 44911), (1, 1, 44912), (1, 1, 44913), (1, 1, 44914), (1, 1, 44915), (1, 1, 44916), (1, 1, 44917), (1, 1, 44918), (1, 1, 44919)', @nombreTabla = 'RimTest7'
SELECT * FROM RimTest7
/*-----------------------------------------------------------------------------------------------------------------------*/

/*» dbo.usp_Rim_Procedimiento_AlterTablaDinamica ... */
/*-----------------------------------------------------------------------------------------------------------------------*/
CREATE OR ALTER PROCEDURE dbo.usp_Rim_Procedimiento_AlterTablaDinamica
(
	@queryString NVARCHAR(MAX)
)
AS
BEGIN
	BEGIN TRY

		BEGIN TRAN Tran_AlterTablaDinamica
		EXEC SP_EXECUTESQL @queryString
		COMMIT TRAN Tran_AlterTablaDinamica

		SELECT @@ROWCOUNT

	END TRY
	BEGIN CATCH
		ROLLBACK TRAN Tran_AlterTablaDinamica
	END CATCH
END

/*» Test ...*/
EXEC dbo.usp_Rim_Procedimiento_AlterTablaDinamica 'RimTest7', ' VALUES(1, 1, 44661), (1, 1, 44662), (1, 1, 44663), (1, 1, 44664), (1, 1, 44665), (1, 1, 44666), (1, 1, 44667), (1, 1, 44668), (1, 1, 44669), (1, 1, 44670), (1, 1, 44671), (1, 1, 44672), (1, 1, 44673), (1, 1, 44674), (1, 1, 44675), (1, 1, 44676), (1, 1, 44677), (1, 1, 44678), (1, 1, 44679), (1, 1, 44680), (1, 1, 44681), (1, 1, 44682), (1, 1, 44683), (1, 1, 44684), (1, 1, 44685), (1, 1, 44686), (1, 1, 44687), (1, 1, 44688), (1, 1, 44689), (1, 1, 44690), (1, 1, 44691), (1, 1, 44692), (1, 1, 44693), (1, 1, 44694), (1, 1, 44695), (1, 1, 44696), (1, 1, 44697), (1, 1, 44698), (1, 1, 44699), (1, 1, 44700), (1, 1, 44701), (1, 1, 44702), (1, 1, 44703), (1, 1, 44704), (1, 1, 44705), (1, 1, 44706), (1, 1, 44707), (1, 1, 44708), (1, 1, 44709), (1, 1, 44710), (1, 1, 44711), (1, 1, 44712), (1, 1, 44713), (1, 1, 44714), (1, 1, 44715), (1, 1, 44716), (1, 1, 44717), (1, 1, 44718), (1, 1, 44719), (1, 1, 44720), (1, 1, 44721), (1, 1, 44722), (1, 1, 44723), (1, 1, 44724), (1, 1, 44725), (1, 1, 44726), (1, 1, 44727), (1, 1, 44728), (1, 1, 44729), (1, 1, 44730), (1, 1, 44731), (1, 1, 44732), (1, 1, 44733), (1, 1, 44734), (1, 1, 44735), (1, 1, 44736), (1, 1, 44737), (1, 1, 44738), (1, 1, 44739), (1, 1, 44740), (1, 1, 44741), (1, 1, 44742), (1, 1, 44743), (1, 1, 44744), (1, 1, 44745), (1, 1, 44746), (1, 1, 44747), (1, 1, 44748), (1, 1, 44749), (1, 1, 44750), (1, 1, 44751), (1, 1, 44752), (1, 1, 44753), (1, 1, 44754), (1, 1, 44755), (1, 1, 44756), (1, 1, 44757), (1, 1, 44758), (1, 1, 44759), (1, 1, 44760), (1, 1, 44761), (1, 1, 44762), (1, 1, 44763), (1, 1, 44764), (1, 1, 44765), (1, 1, 44766), (1, 1, 44767), (1, 1, 44768), (1, 1, 44769), (1, 1, 44770), (1, 1, 44771), (1, 1, 44772), (1, 1, 44773), (1, 1, 44774), (1, 1, 44775), (1, 1, 44776), (1, 1, 44777), (1, 1, 44778), (1, 1, 44779), (1, 1, 44780), (1, 1, 44781), (1, 1, 44782), (1, 1, 44783), (1, 1, 44784), (1, 1, 44785), (1, 1, 44786), (1, 1, 44787), (1, 1, 44788), (1, 1, 44789), (1, 1, 44790), (1, 1, 44791), (1, 1, 44792), (1, 1, 44793), (1, 1, 44794), (1, 1, 44795), (1, 1, 44796), (1, 1, 44797), (1, 1, 44798), (1, 1, 44799), (1, 1, 44800), (1, 1, 44801), (1, 1, 44802), (1, 1, 44803), (1, 1, 44804), (1, 1, 44805), (1, 1, 44806), (1, 1, 44807), (1, 1, 44808), (1, 1, 44809), (1, 1, 44810), (1, 1, 44811), (1, 1, 44812), (1, 1, 44813), (1, 1, 44814), (1, 1, 44815), (1, 1, 44816), (1, 1, 44817), (1, 1, 44818), (1, 1, 44819), (1, 1, 44820), (1, 1, 44821), (1, 1, 44822), (1, 1, 44823), (1, 1, 44824), (1, 1, 44825), (1, 1, 44826), (1, 1, 44827), (1, 1, 44828), (1, 1, 44829), (1, 1, 44830), (1, 1, 44831), (1, 1, 44832), (1, 1, 44833), (1, 1, 44834), (1, 1, 44835), (1, 1, 44836), (1, 1, 44837), (1, 1, 44838), (1, 1, 44839), (1, 1, 44840), (1, 1, 44841), (1, 1, 44842), (1, 1, 44843), (1, 1, 44844), (1, 1, 44845), (1, 1, 44846), (1, 1, 44847), (1, 1, 44848), (1, 1, 44849), (1, 1, 44850), (1, 1, 44851), (1, 1, 44852), (1, 1, 44853), (1, 1, 44854), (1, 1, 44855), (1, 1, 44856), (1, 1, 44857), (1, 1, 44858), (1, 1, 44859), (1, 1, 44860), (1, 1, 44861), (1, 1, 44862), (1, 1, 44863), (1, 1, 44864), (1, 1, 44865), (1, 1, 44866), (1, 1, 44867), (1, 1, 44868), (1, 1, 44869), (1, 1, 44870), (1, 1, 44871), (1, 1, 44872), (1, 1, 44873), (1, 1, 44874), (1, 1, 44875), (1, 1, 44876), (1, 1, 44877), (1, 1, 44878), (1, 1, 44879), (1, 1, 44880), (1, 1, 44881), (1, 1, 44882), (1, 1, 44883), (1, 1, 44884), (1, 1, 44885), (1, 1, 44886), (1, 1, 44887), (1, 1, 44888), (1, 1, 44889), (1, 1, 44890), (1, 1, 44891), (1, 1, 44892), (1, 1, 44893), (1, 1, 44894), (1, 1, 44895), (1, 1, 44896), (1, 1, 44897), (1, 1, 44898), (1, 1, 44899), (1, 1, 44900), (1, 1, 44901), (1, 1, 44902), (1, 1, 44903), (1, 1, 44904), (1, 1, 44905), (1, 1, 44906), (1, 1, 44907), (1, 1, 44908), (1, 1, 44909), (1, 1, 44910), (1, 1, 44911), (1, 1, 44912), (1, 1, 44913), (1, 1, 44914), (1, 1, 44915), (1, 1, 44916), (1, 1, 44917), (1, 1, 44918), (1, 1, 44919)'
SELECT * FROM RimTest7  --dCantidad3_e
/*-----------------------------------------------------------------------------------------------------------------------*/











	7